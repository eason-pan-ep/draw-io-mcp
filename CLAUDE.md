# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Model Context Protocol (MCP) server that enables Claude Desktop to create and manipulate Draw.io diagrams. It provides tools for creating diagrams, adding shapes, connecting elements, and reading diagram contents.

## Development Commands

```bash
# Install dependencies
npm install

# Build the TypeScript project
npm run build

# Watch mode for development
npm run watch
```

## Architecture

### Project Structure

- `src/index.ts` - Main MCP server implementation
- `dist/` - Compiled JavaScript output (generated by TypeScript)
- `package.json` - Project dependencies and scripts
- `tsconfig.json` - TypeScript configuration

### MCP Server Implementation

The server is implemented using the `@modelcontextprotocol/sdk` and communicates via stdio:

1. **Server Setup** (`DrawioMCPServer` class)
   - Initializes MCP server with tool capabilities
   - Sets up request handlers for ListTools and CallTool
   - Manages shape/connector ID generation

2. **Tool Handlers**
   - `create_diagram` - Creates new .drawio XML files with proper structure
   - `add_shape` - Adds shapes with configurable type, position, size, and colors
   - `add_connector` - Adds edges/arrows between shapes with different styles
   - `read_diagram` - Returns raw XML content of diagrams
   - `list_shapes` - Parses XML to extract shape information

3. **XML Generation**
   - All diagram data is stored as XML following Draw.io's mxGraph format
   - Shapes are `mxCell` elements with `vertex="1"` attribute
   - Connectors are `mxCell` elements with `edge="1"` attribute
   - Each element has geometry, style, and parent references

### Draw.io File Format

- Files use `.drawio` extension (XML format)
- Structure: `<mxfile>` → `<diagram>` → `<mxGraphModel>` → `<root>` → `<mxCell>` elements
- Two default cells (id="0" and id="1") serve as the root layer
- All shapes and connectors are children of cell id="1"
- Geometry is specified with x, y, width, height attributes
- Styles are semicolon-separated key-value pairs

### Shape Types and Styles

Supported shapes with their base styles:
- `rectangle` - Basic rectangle
- `ellipse` - Oval/circle shape
- `rhombus` - Diamond shape (commonly used for decisions)
- `cylinder` - Database/storage symbol
- `hexagon` - Six-sided shape
- `cloud` - Cloud computing symbol
- `step`, `parallelogram`, `trapezoid`, `triangle` - Other geometric shapes

Connector styles:
- `straight` - Direct line between shapes
- `curved` - Bezier curved line
- `orthogonal` - Right-angled connections (default)

### Key Implementation Details

1. **ID Management**: Sequential ID generation starting from 2 (0 and 1 are reserved for root cells)
2. **XML Escaping**: All user text is properly escaped to prevent XML injection
3. **File Validation**: Ensures .drawio extension on file creation
4. **Directory Creation**: Automatically creates parent directories as needed
5. **Error Handling**: All tool calls wrapped in try-catch with proper error responses
